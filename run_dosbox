#!/usr/bin/env python3

# pylint: disable=missing-docstring
# pylint: disable=fixme

import argparse
import subprocess
import sys
import os

# X-COM: UFO Defense (7760)
# Works. Uses runme.exe as launcher for dropbox.exe
#
# X-COM: Terror from the Deep (7650)
# Works. Uses runme.exe as launcher for dropbox.exe
#
# STAR WARS™ - Dark Forces (32400)
# Works after manual fix.
# File is named Dosbox.conf and mount path in file is wrong
#
# Tomb Raider I (224960)
# Does not work. Uses DOSBox with additional patches.
#
# MegaRace 2 (733760)
# TBD


def run(cmd_line, wait=False):

    if wait:
        print('wait for dropbox to stop')

    _folder, exe = os.path.split(cmd_line[0])

    if exe.lower() == 'dosbox.exe' or os.path.isfile('dosbox.conf'):
        # Basic use-case is dosbox.conf file in top-level game dir
        # that includes autoexec section.
        subprocess.call(['dosbox'])
    else:
        print('run_dosbox: silently ignoring executable: ', cmd_line)


def main():
    parser = argparse.ArgumentParser()
    group = parser.add_mutually_exclusive_group()
    group.add_argument('--get-native-path', action='store_true')
    group.add_argument('--get-compat-path', action='store_true')
    group.add_argument('--wait-before-run', action='store_true')
    group.add_argument('--get-current-step')
    parser.add_argument('commands', nargs='*')
    args = parser.parse_intermixed_args()

    if args.get_native_path:
        # FIXME convert single path: windows -> linux
        sys.exit(1)
    elif args.get_compat_path:
        # FIXME convert single path: linux -> windows
        sys.exit(1)
    elif args.get_current_step:
        # Steam sometimes ivokes this even when it's not defined in
        # toolmanifest…
        sys.exit(1)
    else:
        run(args.commands, wait=args.wait_before_run)


if __name__ == "__main__":
    main()
